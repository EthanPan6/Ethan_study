"use strict";var express=require("express"),URL=require("url"),https=require("https"),router=express.Router(),url2="https://m.kongfz.com/api-search/Suggest/Suggest/suggest?bizType=wap&query=";router.get("/search",function(r,n){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:n.append("Access-Control-Allow-Origin","*"),t=URL.parse(r.url,!0).query,https.get(url2+t.searchtext,function(e){e.setEncoding("utf-8");var r="";e.on("data",function(e){r+=e}),e.on("end",function(){n.json(JSON.parse(r))}).on("error",function(e){console.error("出现错误:".concat(e.message))})});case 3:case"end":return e.stop()}})});var MongoClient=require("mongodb").MongoClient,dbUrl="mongodb://localhost:27017/";MongoClient.connect(dbUrl,{useNewUrlParser:!0,useUnifiedTopology:!0},function(e,r){if(e)throw e;var o=r.db("kongfz");router.get("/result",function(r,n){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:n.append("Access-Control-Allow-Origin","*"),t=URL.parse(r.url,!0).query,o.collection("resultList").find({itemName:t.key}).limit(parseInt(t.count)).toArray(function(e,r){if(e)throw e;n.json(r)});case 3:case"end":return e.stop()}})}),router.post("/login",function(r,u){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:u.append("Access-Control-Allow-Origin","*"),n=JSON.parse(JSON.stringify(r.body)),o.collection("userList").find(n).toArray(function(e,r){if(e)throw e;console.log(r);var n=r[0],t=n.username,o=n.password,s=n.tel;console.log(t,o,s);var i=Buffer.from(JSON.stringify(o+'"pt"'+s)).toString("base64").split("").reverse().join("");u.json({username:t,token:i})});case 3:case"end":return e.stop()}})}),router.post("/register",function(r,i){var u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:i.append("Access-Control-Allow-Origin","*"),u=JSON.parse(JSON.stringify(r.body)),o.collection("userList").insertOne(u,function(e,r){if(e)throw e;var n=u.password,t=u.tel,o="用户"+t.substr(-4),s=Buffer.from(JSON.stringify(n+'"pt"'+t)).toString("base64").split("").reverse().join("");i.json({username:o,token:s})});case 3:case"end":return e.stop()}})})}),module.exports=router;